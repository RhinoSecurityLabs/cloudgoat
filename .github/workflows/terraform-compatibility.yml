name: Terraform Compatibility Test

on:
  pull_request:
    paths:
      - "Dockerfile"
      - "requirements.txt"
      - "cloudgoat/scenarios/**"
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        terraform_version: [0.14.11, 1.0.11, 1.10.0]
    steps:
      - name: Checkout full repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Terraform ${{ matrix.terraform_version }}
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ matrix.terraform_version }}

      - name: Configure AWS Credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/config
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id = $AWS_ACCESS_KEY_ID" >> ~/.aws/credentials
          echo "aws_secret_access_key = $AWS_SECRET_ACCESS_KEY" >> ~/.aws/credentials
          echo "region = $AWS_REGION" >> ~/.aws/config
          export AWS_PROFILE=default

      - name: Find and Validate Terraform Configurations
        run: |
          find cloudgoat/scenarios -type d -name "terraform" | while read dir; do
            echo "Testing Terraform in $dir"
            cd "$dir"

            # Ensure variables.tf exists and includes profile + region variables
            if ! grep -q 'variable "profile"' variables.tf 2>/dev/null; then
              echo 'variable "profile" { default = "default" }' >> variables.tf
            fi
            if ! grep -q 'variable "region"' variables.tf 2>/dev/null; then
              echo 'variable "region" { default = "us-east-1" }' >> variables.tf
            fi

            terraform init || { echo "Init failed for $dir"; exit 1; }
            terraform validate || { echo "Validation failed for $dir"; exit 1; }
            terraform plan -out=tfplan -var="cgid=github-ci-test" -var="profile=default" -var="region=us-east-1" || { echo "Plan failed for $dir"; exit 1; }

            cd - > /dev/null
          done
  